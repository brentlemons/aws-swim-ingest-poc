AWSTemplateFormatVersion: '2010-09-09'
Description: Template describing the service infrastructure
Parameters:
  GitHubUsername:
    Type: String
    Description: Which branch to use.
  GitHubRepoName:
    Type: String
    Description: Which branch to use.
    Default: aws-swim-ingest-poc
  GitHubBranchName:
    Type: String
    Description: Which branch to use.
    Default: master
  GitHubToken:
    Type: String
    Description: Which branch to use.
Resources:
  ArtifactBucket:
    Type: AWS::S3::Bucket
  IamRoles:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/bkl-swim-codepipeline/53b561c3da901a0ef12d5b743796711d.template
      Parameters:
        ArtifactBucketName:
          Ref: ArtifactBucket
  ECRRepository:
    Type: AWS::ECR::Repository
  CodePipeline:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/bkl-swim-codepipeline/f64ff9851666d2a9c579d8db2e86c2b5.template
      Parameters:
        ArtifactBucketName:
          Ref: ArtifactBucket
        ECRRepositoryName:
          Ref: ECRRepository
        CodePipelineServiceRoleArn:
          Fn::GetAtt:
          - IamRoles
          - Outputs.CodePipelineServiceRoleArn
        CodeBuildServiceRoleArn:
          Fn::GetAtt:
          - IamRoles
          - Outputs.CodeBuildServiceRoleArn
        GitHubUsername:
          Ref: GitHubUsername
        GitHubRepoName:
          Ref: GitHubRepoName
        GitHubBranchName:
          Ref: GitHubBranchName
        GitHubToken:
          Ref: GitHubToken
Outputs:
  ArtifactBucketName:
    Value:
      Ref: ArtifactBucket
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ArtifactBucketName
  ECRRepositoryName:
    Value:
      Ref: ECRRepository
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ECRRepositoryName
